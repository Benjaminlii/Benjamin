# 第11章 晚期(运行期)优化

------

[TOC]

------

## 1. 概述

​		Java程序最初是通过解释器进行解释执行的,当虚拟机发现某个方法或代码块运行特别频繁是,就会吧这些代码认定为"热点代码".为了提高热点代码的运行效率,在运行时,虚拟机将会把这些代码编译成与本地平台相关的机器码,并进行各个层次的优化,完成这个任务的编译器成为即时编译器.

## 2. HotSpot虚拟机内的即时编译器

### (1). 解释器与编译器

​		当程序需要迅速启动和执行的时候,解释器可以迅速发挥作用,省去编译时间立即执行程序.程序运行后,随着时间的推移,编译期逐渐发挥作用,把越来越多的代码编译成本地代码,可以获取更高的运行效率.

​		解释执行可以节约内存,编译执行可以提升效率.这二者可以根据需要相互转换.

​		解释器还可以作为编译期激进优化的后门,在编译期进行激进优化出现错误时,可以改为解释执行来"读档"恢复成原状态.

​		HotSpot虚拟机中内置了两个即时编译器.目前主流的HotSpot虚拟机中默认采用解释器与其中一个编译器直接配合的防止工作,程序使用哪个编译器,去结余虚拟机运行的模式.

​		解释器与编译器搭配使用的方式在虚拟机中成为"混合模式",可以使用参数设置使用"编译模式","解释模式"或者"混合模式".

​		由于即时编译器编译本地代码需要占用程序运行时间,解释器可能还要收集性能监控信息,对解释执行的速度也有影响.为了在程序启动响应速度和运行效率之间达到最佳平衡,HotSpot虚拟机会逐渐启动分层编译的策略.分层编译根据编译器编译,优化的规模与耗时,互粉出不同编译的层次:

-   第0层,程序解释执行,解释器不开启性能监控,可以触发第1层编译.
-   第1层,将字节码编译为本地代码,进行简单,可靠的优化,有必要的话会加入性能监控.
-   第2层,也是将字节码编译为本地代码,但进行的是一些编译耗时较长的优化,甚至根据性能监控信息进行一些不可靠的激进优化.

### (2). 编译对象与触发条件

