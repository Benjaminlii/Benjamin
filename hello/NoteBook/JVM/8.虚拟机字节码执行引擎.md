# 第八章 虚拟机字节码执行引擎

------

[TOC]

------

## 1. 概述

​		所有的Java虚拟机的执行引擎都是一致的:输入的是字节码文件,处理过程是字节码解析的等效过程,输出的是执行结果.

## 2. 运行时帧栈结构

​		栈帧是用于支持虚拟机进行方法调用和方法执行的数据结构,它是虚拟机运行时数据区中的虚拟机栈的栈元素(一个栈帧代表一层方法调用).每一个栈帧都包括了局部变量表,操作数栈,动态链接,方法返回地址和一些额外的附加信息.

​		在编译代码的时候,栈帧中需要多大的局部变量表,多深的操作数栈都是已经完全确定了,并且写入到方法表的Code属性中了的,因此一个栈帧需要分配多大内存不会受到程序运行的影响,仅仅取决于虚拟机的具体实现.

​		一个线程中的方法调用链可能会很长,,对于执行引擎来说,在活动线程中,只有**<u>位于栈顶的栈帧才是有效的,成为当前栈帧,与这个栈帧对应的方法称为当前方法</u>**.

​		典型的栈帧结构如下所示:

![栈帧的概念结构](https://images2015.cnblogs.com/blog/990532/201611/990532-20161113064456420-1511672121.jpg)

### (1). 局部变量表

​		局部变量表是一组变量值存储空间,用于存放方法参数和方法内部定义的局部变量.

​		局部变量表的容量以变量槽(Slot)为最小单位,虚拟机规范中并没有制定一个Slot的大小,只是很有导向性的指明"每个Slot都应该能存放一个boolean,byte,char,short,int,float,reference或者returnAddress类型的数据".二这八种数据类型都可以使用32字节来存放,但这并不代表一个Slot就是32字节,仅仅代表Slot的长度可以随着处理器,操作系统或虚拟机的不同而发生变化.

​		对于64位的数据类型,虚拟机会以高位对齐的方式为其分配两个连续的Slot空间.

​		虚拟机通过索引定位的方式使用局部变量表,索引的范围是从0开始带局部变量表最大的Slot数量.对于64位数据类型的变量,会同时使用n和n+1两个Slot,这种情况下,不允许采用任何方式单独访问其中任意一个Slot,如果遇到了这种字节码指令,Java虚拟机会在校验阶段抛出异常.

​		方法执行时,虚拟机是使用局部变量表完成参数值到参数列表的传递的,如果是实例方法(非static),第0位索引值的Slot默认是用于传递方法所属对象,也就是this对象的引用的.其余参数按照参数表顺序排列,占用从1开始的后续的Slot,参数表分配完后,再根据方法体内部定义的变量的顺序和作用域分配其余的Slot.

​		为了尽可能的节省栈帧空间,局部变量表中的Slot是可以重用的,如果一个变量的作用域已经失效了,这个Slot就会被分配给新的变量使用.

### (2). 操作数栈

​		操作数栈也常常被称为操作栈,它是一个后入先出的栈.与局部变量表一样,操作数栈的最大深度也在编译的时候就已经写入到了Code属性中了.操作数栈的每一个元素可以使任意的Java数据类型,包括64位的long和double(占据的栈容量为2).

​		当一个方法开始执行的时候,操作数栈是空的,方法执行过程中,随着各种指令的直接作用或者需要,往操作数栈中写入和提取内容.例如,如果要进行 `int a = 1 + 1;`,虚拟机会先将1和1压入操作数栈,然后执行相加的命令,这个命令就会从操作数栈中取出两个值进行求和的操作,然后返回结果值.

​		大多数的虚拟机中都会对操作数栈做一些优化处理,另两个帧栈出现一部分重叠,是的两个方法间可以实现变量共享.