# 第七章 虚拟机加载机制

------

[TOC]

------

## 1. 概述

​		虚拟机把描述类的数据从Class文件加载到内存,并对数据进行校验,转换解析和初始化,最终形成可以被虚拟机直接使用的Java类型,这就是虚拟机的类加载机制.

## 2. 类加载的时机

​		一个类的生命周期:加载(Loading),验证(Verification),准备(Preparation),解析(Resolution),初始化(Initialization),使用(Using)和卸载(Unloading)七个阶段.验证,准备,解析这三个阶段统称为连接.

![类的生命周期](https://img2018.cnblogs.com/blog/1595409/201905/1595409-20190521154930506-891623513.png)

​		加载,验证,准备,初始化和卸载这五个阶段的先后顺序是确定的,而解析阶段则不一定,某些情况下也可能在初始化阶段之后进行.

​		加载阶段的执行交由虚拟机的具体实现来自由把握,而初始化阶段则有严格的规定:

-   遇到new,getstatic,putstatic或invokestatic这4条字节码指令时,如果类没有进行过初始化,就需要先触发其初始化.
-   使用java.lang.reflect包的方法对类进行反射调用的时候,如果类没有进行过初始化,则先进行初始化.
-   对一个类进行初始化的时候,发现它的父类没有进行初始化,就对父类进行初始化.
-   虚拟机启动时,用户制定一个要执行的主类,虚拟机就会初始化这个主类.
-   使用JDK 1.7的动态语言支持时,如果一个java.lang.invoke.MethodHandle实例最后的解析结果REF_getStatic,REF_putStatic,REF_invokeStatic的方法句柄,并且这个方法句柄没有初始化,那么先进行初始化.

对于以上的5种情况,虚拟机给出的限定语是当且仅当.

​		对于接口的初始化,与类有不同的只有第3点:当真正使用到父接口的时候(如引用接口中定义的常量),才会初始化父接口.

