# 第6章 锁

-----

[TOC]

-----

​		锁的出现主要是最大程度利用数据库的并发访问的同时,还要确保每个用户能以一致的方式读取和修改数据

## 1. 什么是锁

​		锁机制用于管理对共享资源的并发访问.InnoDB存储引擎会在行级别上对表数据上锁.数据库系统使用锁是为了支持对共享资源并发访问,提供数据的完整性和一致性.

​		MyISAM存储引擎使用表锁,读取性能良好,但是并发插入性能就要差一些.

## 2. lock与latch

​		锁分为两种:lock与latch.在数据库中,lock与latch都可以被称为锁,但是latch一本被称为闩(shuan)锁(轻量级).要求锁定的时间非常短,如果持续时间成,应用的性能会非常差.

​		在InnoDB存储引擎中,latch又可以被分为mutex(互斥量)和rwlock(读写锁).设计的目的是用来摆正并发线程操作临界资源的正确性,通常没有死锁检测.

​		lock的对象是事务,用来锁定的是数据库中的对象(表,页,行等).一般lock的对象只在事务提交或者回滚后释放,有死锁机制.

lock与latch的比较:

|          | lock                 | latch                              |
| -------- | -------------------- | ---------------------------------- |
| 对象     | 事务                 | 线程                               |
| 保护     | 数据库内容           | 内存数据结构                       |
| 持续时间 | 整个事务过程         | 临界资源                           |
| 模式     | 行锁,表锁,意向锁     | 读写锁,互斥量                      |
| 死锁     | 有死锁检测和处理     | 仅通过应用程序的顺序保证无死锁现象 |
| 存在于   | lock manager的哈希表 | 每个数据结构的对象中               |

## 3. InnoDB存储引擎中的锁

### (1). 锁的类型

​		InnoDB存储引擎实现了以下两种锁:

-   共享锁(S Lock,读锁),允许读取一行数据
-   排他锁(X Lock,写锁),允许事务删除或者更新一行数据

​		以上两种都是行锁

​		读锁和读锁之间是兼容的,写锁与任何锁都不兼容.

​		InnoDB存储引擎支持意向锁,即表级别的锁:

-   意向共享锁(IS Lock),事务想要获得一张表中某几行的共享锁
-   意向排它锁(IX Lock),事务想要获得一张表中某几行和排它锁