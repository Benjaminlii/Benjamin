# 第二部分 单机数据库的实现

------

[toc]

------

## 1. 数据库

​		本章说明服务器保存数据库的方法,客户端切换数据库的方法,数据库保存键值对的方法,还有针对数据库的增删改查等操作的实现方法等等.

### (1). 服务器中的数据库

>   这里说的数据库是指一个Redis程序中的多个命名空间,它们相互无关,所以认为是不同的库.

​		Redis服务器将所有数据库都保存在redis.h/redisServer结构的db数组中,db数组中的每一个元素都是一个redis.h/redisDb结构.每一个redisDb结构代表一个数据库.

```c
struct redisServer{
    // ......
    
    // db数组
    redisDb *db;
    
    // 服务器的数据库数量
    int dbnum;
    
    // .....
};
```

​		dbnum的值默认为16,可以通过配置更改.

### (2). 切换数据库

​		初始化完成后,默认使用的数据库是0号数据库,可以使用SELECT命令切换数据库.

```
redis> SET msg "hello"
OK
redis> GET msg
"hello"
redis> SELECT 1
OK

redis[1]> GET msg
(nil)
```

​		在服务器内部,客户端状态redisClient结构(每一个Redis客户端连接服务端,就有一个该结构的实例)的db属性记录了客户端当前的目标数据库.也就是说这个结构用于服务端在对客户端发出的命令进行响应时,选择哪一个数据库进行响应.

```c
typedef struct redisClient{
    // .....
    
    // 记录客户端正在使用的数据库,指向之前db数组中的一个元素
    redis *db;
    
    // .....
} redisClient;
```

>   Redis没有返回数据库的命令,也就是说,除了Redis命令行中会有号码外,不能得知当前使用的是哪一个数据库,因此在其他语言中通过接口使用Redis数据库,要谨防多次切换数据库后忘记当前使用的是哪一个数据库.
>
>   安全起见,最好先执行一个SELECT进行切换.

### (3). 数据库键空间

​		Redis是一个键值对数据库服务器,服务器中的每一个数据库都由一个redis.h/redisDb表示.其中的dict是一个字典,存储了这个数据库所有的键值对,被称为键空间.

```c
typedef struct redisDb{
    // .....
    
    // 数据库键空间,是一个字典,保存了数据库中所有的键值对
    dict *dict;
    
    // .....
} redisDb;
```

​		同字典一样,键空间的键都是string对象,值可以使任意的redisObject.

​		对数据库的操作,比如新建一个字符串键,都是通过对键空间这个字典的操作来实现的.增删改查都是如此.

### (4). 设置键的生存时间

​		通过EXPIRE命令或者PEXPIRE命令,可以以秒或者毫秒的精度为数据库中的一个键设置生存时间.经过指定的一段时间后,服务器就会自动删除生存时间为0的键.

​		SETEX命令可以在声明字符串的时候就设置生存时间,后面分布式锁会用到.只能用于字符串.

​		和EXPIRE命令或者PEXPIRE命令类似,还可以使用EXPIREAT命令或者PEXPIREAT命令设置键的死亡时刻,传入一个UNIX时间戳.到达这个时间戳,这个对象就被清理.

​		TTl和PTTL命令接受一个带有生存时间或者死亡时刻的键,返回不同时间精度的剩余存活时长.

​		实际上底层都是通过PEXPIREAT命令实现的

#### 1). 保存过期时间

​		redisDB结构的expires字典保存了数据库中所有键的过期时间,我们也成这个键为过期字典.

```c
typedef struct redisDb{
    // .....
    
    // 数据库键空间,是一个字典,保存了数据库中所有的键值对
    dict *dict;
 	
    // 过期字典
    dict expires;
    // .....
} redisDb;
```

​		设置一个键的过期时间实际上就是在过期字典中添加一个string和string的键值对,只不过值存储的是long long类型的时间.

​		那么很明显,移除过期时间就是将过期字典中的一个键值对移除.返回过期时间就是相应的查询操作.

#### 2). 过期键的判定

​		使用过期字典,可以通过以下方式检查一个键是否过期:

1.  检查这个键是否存在于过期字典,如果存在那么取得过期时间戳,如果不存在那么一定没过期
1.  将过期时间戳与当前的UNIX时间戳进行比较,如果是过去的时间戳,那么这个键过期了.